@using Exato.Front.Features.Office.GetCommands
@using Exato.Front.Features.Office.GetCommandBatch
@using Exato.Shared.Features.Office.GetCommandBatch
@using Exato.Front.Features.Office.GetCommandBatches
@using Exato.Front.Features.Office.GetCommandBatchCommands
@using Exato.Shared.Features.Office.GetCommandBatchCommands

@namespace Exato.Front.Pages.Office

@page "/office/command-batches/{id:guid}"
@attribute [Authorize(Policies.ViewOfficeCommandBatchPage)]

<ExatoPageTitle Title="Lote" />

<MudContainer Class="my-4 px-4">
    <MudCard>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" sm="8" md="8" lg="8">
                    <MudStack Row AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.BorderOuter" Class="mb-1" Size="Size.Large"/>
                        <MudText Typo="Typo.h5" Class="mt-1" Style="font-weight: bold">@_data.Type.GetDescription()</MudText>
                    </MudStack>
                </MudItem>
                <MudItem xs="12" sm="4" md="4" lg="4" Class="d-flex justify-end">
                    <MudChip
                        T="string"
                        Class="px-5 ma-0"
                        Size="Size.Large"
                        Icon="@_data.Status.GetIcon()"
                        Color="@_data.Status.GetColor()"
                        IconColor="Color.Default"
                    >
                        @_data.Status.GetDescription()
                    </MudChip>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <MudContainer Class="px-0 my-4">
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="4" md="4" lg="4">
                <InfoCard Icon="@Icons.Material.Filled.AccessTime" Color="@Colors.BlueGray.Lighten4" Title="Criado" Content="@_data.CreatedAt.ToDateTimeString()" />
            </MudItem>
            <MudItem xs="12" sm="4" md="4" lg="4">
                <InfoCard Icon="@Icons.Material.Filled.AccessTimeFilled" Color="@GetProcessedAtIconColor()" Title="Processado" Content="@_data.ProcessedAt.ToDateTimeString()" />
            </MudItem>
            <MudItem xs="12" sm="4" md="4" lg="4">
                <InfoCard Icon="@Icons.Material.Filled.GridView" Color="@Colors.Indigo.Darken1" Title="Tamanho" Content="@_data.Size.ToIntFormat()" />
            </MudItem>
        </MudGrid>
    </MudContainer>

    <MudContainer Class="my-4 px-0">
        <MudContainer Class="px-0 my-4">
            <MudTable @ref="@_table" Items="@_commands.Items" Loading="@_loading" RowsPerPage="10" Hover Dense Class="pt-2">
                <ToolBarContent>
                    <MudGrid Justify="Justify.FlexStart" Class="mr-2">
                        <MudItem xs="12" sm="3" md="3" lg="3">
                            <MudSelect
                                Dense
                                Margin="Margin.Dense"
                                Variant="Variant.Outlined"
                                @bind-Value="@_status"
                                @bind-Value:after="@Refresh"
                                Label="Status"
                                Clearable
                            >
                                @foreach (CommandStatus? item in Enum.GetValues<CommandStatus>())
                                {
                                    <MudSelectItem Value="@item">
                                        <MudStack Row AlignItems="AlignItems.Center">
                                            <MudIcon Class="mb-1" Icon="@item.Value.GetIcon()" Color="@item.Value.GetColor()" Size="Size.Small" />
                                            <MudText>@item.GetDescription()</MudText>
                                        </MudStack>
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="6" lg="6">
                            <MudSelect
                                Dense
                                Margin="Margin.Dense"
                                Variant="Variant.Outlined"
                                @bind-Value="@_type"
                                @bind-Value:after="@Refresh"
                                Label="Tipo"
                                Clearable
                            >
                                @foreach (var type in _commands.Types)
                                {
                                    <MudSelectItem Value="@type">@type.Split('.').Last()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Tipo</MudTh>
                    <MudTh>Criado</MudTh>
                    <MudTh>Processado</MudTh>
                    <MudTh>Duração (ms)</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Tipo">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Class="mb-1" Icon="@context.Status.GetIcon()" Color="@context.Status.GetColor()" Size="Size.Small" />
                            <MudText Typo="Typo.body2">@context.Type.Split('.').Last()</MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Criado">@context.CreatedAt.ToDateTimeString()</MudTd>
                    <MudTd DataLabel="Processado">@context.ProcessedAt.ToDateTimeString()</MudTd>
                    <MudTd DataLabel="Duração (ms)">@context.Duration.ToIntFormat()</MudTd>
                    <MudTd>
                        <MudTooltip Text="Detalhes" Arrow Placement="Placement.Top" ShowOnFocus="false">
                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.RemoveRedEye" Href="@($"/office/commands/{context.Id}")" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudDivider DividerType="DividerType.FullWidth"/>
                    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mx-4">
                        <MudTooltip Text="Total de registros" Arrow Placement="Placement.Top">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Size="@Size.Medium" Icon="@Icons.Material.Filled.ViewHeadline" />
                                <MudText><strong>@_commands.Total.ToIntFormat()</strong></MudText>
                            </MudStack>
                        </MudTooltip>
                        <MudPagination
                            Rectangular
                            Class="pa-4"
                            MiddleCount="3"
                            BoundaryCount="1"
                            Color="Color.Secondary"
                            @bind-Selected="@_page"
                            @bind-Selected:after="@HandlePageChange"
                            Variant="Variant.Text"
                            Count="@((_commands.Total + 9) / 10)"
                        />
                    </MudStack>
                </PagerContent>
                <NoRecordsContent>
                    Nenhum comando encontrado.
                </NoRecordsContent>
            </MudTable>
        </MudContainer>
    </MudContainer>
</MudContainer>

@inject GetCommandBatchClient GetCommandBatchClient
@inject GetCommandBatchCommandsClient GetCommandBatchCommandsClient

@code
{
	[Parameter]
	public Guid Id { get; set; }

    private int _page = 1;
    private bool _loading;

    private string? _type;
    private CommandStatus? _status;

    private GetCommandBatchOut _data = new();

    private MudTable<GetCommandBatchCommandsItemOut> _table;
    private GetCommandBatchCommandsOut _commands = new();

    protected override async Task OnInitializedAsync()
    {
        var response = await GetCommandBatchClient.Get(Id);
        if (response.IsSuccess)
        {
            _data = response.Success;
        }
        await Refresh();
    }

    private string GetProcessedAtIconColor()
    {
        return _data.ProcessedAt == null ? Colors.BlueGray.Lighten4 : Colors.Green.Darken1;
    }

    private async Task Refresh()
    {
        _loading = true;

        var query = new GetCommandBatchCommandsIn { Page = 0, Type = _type, Status = _status };
        _commands = await GetCommandBatchCommandsClient.Get(Id, query);

        if (_page != 1)
        {
            _page = 1;
            _table.NavigateTo(0);
        }

        _loading = false;
    }

    private async Task HandlePageChange()
    {
        _loading = true;

        var query = new GetCommandBatchCommandsIn { Page = _page - 1, Type = _type, Status = _status };
        _commands = await GetCommandBatchCommandsClient.Get(Id, query);

        _table.NavigateTo(_page - 1);

        _loading = false;
    }
}
