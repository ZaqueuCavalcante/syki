@using Exato.Front.Features.Office.CriarUsuario
@using Exato.Front.Features.Office.GetWebPayments
@using Exato.Shared.Features.Office.GetWebPayments

@namespace Exato.Front.Pages.Office

@page "/office/web-payments"
@attribute [Authorize(Policies.ViewOfficeWebPaymentsPage)]

<ExatoPageTitle Title="Pagamentos" />

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-4 px-4">
    <ExatoPageHeader Icon="@Icons.Material.Filled.AttachMoney" Title="Pagamentos" />
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="px-0 my-4">
        <MudTable @ref="@_table" Items="@_payments.Items" Loading="@_loading" RowsPerPage="10" Hover Dense Class="pt-2">
            <ToolBarContent>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Code</MudTh>
                <MudTh>Usuário</MudTh>
                <MudTh>Empresa</MudTh>
                <MudTh Class="table-money-column">Valor (R$)</MudTh>
                <MudTh Class="table-money-column">Bônus (R$)</MudTh>
                <MudTh>Início</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Provedor</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Code">@context.GetTransactionCode()</MudTd>
                <MudTd DataLabel="Usuário">@context.User</MudTd>
                <MudTd DataLabel="Empresa">@context.GetCompany()</MudTd>
                <MudTd DataLabel="Valor (R$)" Class="table-money-column">@context.Value.ToBrl(false)</MudTd>
                <MudTd DataLabel="Bônus (R$)" Class="table-money-column">@context.Bonus.ToBrl(false)</MudTd>
                <MudTd DataLabel="Início">@context.StartDate.ToDateTimeString()</MudTd>
                <MudTd DataLabel="Status">@context.Status.GetDescription()</MudTd>
                <MudTd DataLabel="Provedor">@context.GetPaymentProvider()</MudTd>
            </RowTemplate>
            <PagerContent>
                <MudDivider DividerType="DividerType.FullWidth"/>
                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mx-4">
                    <MudTooltip Text="Total de registros" Arrow Placement="Placement.Top">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Size="@Size.Medium" Icon="@Icons.Material.Filled.ViewHeadline" />
                            <MudText><strong>@_payments.Total.ToIntFormat()</strong></MudText>
                        </MudStack>
                    </MudTooltip>
                    <MudPagination
                        Rectangular
                        Class="pa-4"
                        MiddleCount="3"
                        BoundaryCount="1"
                        Color="Color.Secondary"
                        @bind-Selected="@_page"
                        @bind-Selected:after="@HandlePageChange"
                        Variant="Variant.Text"
                        Count="@((_payments.Total + 9) / 10)"
                    />
                </MudStack>
            </PagerContent>
            <NoRecordsContent>
                @GetNotFoundMessage()
            </NoRecordsContent>
        </MudTable>
    </MudContainer>
</MudContainer>

@inject GetWebPaymentsClient Client

@code
{
    private int _page = 1;
    private bool _loading;
    private MudTable<GetWebPaymentsItemOut> _table;

    private GetWebPaymentsOut _payments = new();

    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }

    private string GetNotFoundMessage()
    {
        return "Nenhum pagamento encontrado.";
    }

    private async Task Refresh()
    {
        _loading = true;

        _payments = await Client.Get(new() { Page = 0 });

        if (_page != 1)
        {
            _page = 1;
            _table.NavigateTo(0);
        }

        _loading = false;
    }

    private async Task HandlePageChange()
    {
        _loading = true;

        _payments = await Client.Get(new() { Page = _page - 1 });

        _table.NavigateTo(_page - 1);

        _loading = false;
    }
}
