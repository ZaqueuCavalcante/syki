@using Exato.Front.Components.Usuarios
@using Exato.Front.Components.Empresas

@namespace Exato.Front.Features.Office.VincularEmpresasAoUsuario

<MudDrawer @bind-Open="@_open" Width="@_width" Anchor="Anchor.Right" Elevation="1" Variant="@DrawerVariant.Temporary">
	<MudDrawerHeader Class="justify-space-between">
		<MudStack Row Justify="Justify.FlexStart" AlignItems="AlignItems.Center" Spacing="3">
			<MudIcon Icon="@Icons.Material.Filled.Add" />
			<MudText Typo="Typo.h5"><b>Vincular empresas</b></MudText>
		</MudStack>
		<MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@Close" />
    </MudDrawerHeader>
    <MudGrid Spacing="1" Class="px-7">
        <MudForm @ref="@_form" Model="@_model" Validation="@(VincularEmpresasAoUsuarioFormData.V.ValidateValue)" Style="width: 100%">
            <MudGrid Spacing="2">
                <MudItem xs="12">
                    <ExatoTitleText Icon="@GetSelectedCompaniesIcon()" Text="@GetSelectedCompaniesTitle()" />
                </MudItem>
                <MudItem xs="12">
                    <PotencialEmpresaDoUsuarioSelect
                        Id="@Id"
                        Value="@_model.Empresa"
                        ValueChanged="(PotencialEmpresaDoUsuarioSelectData newValue) => HandleEmpresaChanged(newValue)"
                        For="@(() => _model.Empresa)"
                    />
                </MudItem>
            </MudGrid>
            <MudItem xs="12" Class="mt-2">
                <MudDataGrid
                    Dense
                    Hover
                    Class="my-2"
                    SortMode="SortMode.None"
                    Items="@_model.Empresas"
                >
                    <Columns>
                        <TemplateColumn Title="Empresa">
                            <CellTemplate>
                                <MudStack Spacing="0">
                                    <MudText>@context.Item.Nome</MudText>
                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                        @{ var (color, icon) = context.Item.GetIsActive(); }
                                        <MudIcon Size="@Size.Small" Icon="@icon" Color="color" />
                                        @{ var (typeColor, typeIcon, _) = context.Item.Tipo.GetProps(); }
                                        <MudIcon Size="@Size.Small" Icon="@typeIcon" Color="@typeColor" />
                                        <MudText Typo="Typo.body2">@context.Item.CNPJ.AsFormatedDocument()</MudText>
                                    </MudStack>
                                </MudStack>
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn>
                            <CellTemplate>
                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="@Color.Error" OnClick="@(() => RemoveEmpresa(context.Item))" />
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                    <NoRecordsContent>
                        Nenhuma empresa selecionada.
                    </NoRecordsContent>
                </MudDataGrid>
            </MudItem>
        </MudForm>
    </MudGrid>
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Spacing="3" Class="px-2 py-4">
        <DialogCancelButton OnClick="@Close" />
        <DialogSaveButton OnClick="@Submit" Loading="@_loading" />
    </MudStack>
</MudDrawer>

@inject ISnackbar Snackbar
@inject VincularEmpresasAoUsuarioClient Client
@inject IBrowserViewportService BrowserViewportService

@code
{
    [Parameter]
    public int Id { get; set; }

    [Parameter]
    public EventCallback AfterSubmit { get; set; }

    private bool _open;
    private string _width = "550px";
    private Breakpoint _breakpoint;

    private bool _loading;

    private MudForm _form;
    private VincularEmpresasAoUsuarioFormData _model = new();

    protected override async Task OnInitializedAsync()
    {
        _breakpoint = await BrowserViewportService.GetCurrentBreakpointAsync();
        _width = _breakpoint == Breakpoint.Xs ? "100%" : "550px";
    }

    public async Task Open()
    {
        _loading = true;

        _model = new();
        await _form.ResetAsync();

        _open = true;

        _loading = false;
        StateHasChanged();
    }

    private void Close()
    {
        _open = false;
    }

    private async Task Submit()
    {
        if (_loading) return;

        await _form.Validate();
        if (!_form.IsValid) return;

        _loading = true;
        var response = await Client.Vincular(Id, _model.GetIds());
        if (response.IsSuccess)
        {
            Snackbar.Add("Empresas vinculadas com sucesso!", Severity.Success);
            await AfterSubmit.InvokeAsync();
            _open = false;
        }
        else
        {
            Snackbar.Add(response.Error.Message, Severity.Error);
        }
        _loading = false;
    }

    private void HandleEmpresaChanged(PotencialEmpresaDoUsuarioSelectData newValue)
    {
        if (newValue == null || newValue.Id == 0) return;

        if (_model.Empresas.Any(x => x.Id == newValue.Id)) return;

        _model.Empresas.Add(newValue);
    }

    private void RemoveEmpresa(PotencialEmpresaDoUsuarioSelectData empresa)
    {
        _model.Empresas.Remove(empresa);
    }

    private string GetSelectedCompaniesIcon()
    {
        var count = _model.Empresas.Count;
        if (count == 0) return Icons.Material.Filled.Error;

        return Icons.Material.Filled.Check;
    }

    private string GetSelectedCompaniesTitle()
    {
        var count = _model.Empresas.Count;
        if (count == 0) return "Nenhuma empresa selecionada";

        if (count == 1) return $"1 empresa selecionada";

        return $"{count} empresas selecionadas";
    }
}
