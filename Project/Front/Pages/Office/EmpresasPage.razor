@using Exato.Front.Components.Empresas
@using Exato.Front.Features.Office.CriarEmpresa
@using Exato.Front.Features.Office.BuscarEmpresas
@using Exato.Shared.Features.Office.BuscarEmpresas

@namespace Exato.Front.Pages.Office

@page "/office/empresas"
@attribute [Authorize(Policies.ViewOfficeEmpresasPage)]

<ExatoPageTitle Title="Empresas" />

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-4 px-4">
    <ExatoPageHeader Icon="@Icons.Material.Filled.Business" Title="Empresas" ButtonPolicy="@Policies.OfficeCriarEmpresa" ButtonText="Nova Empresa" OnClick="@OpenDrawer" />
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="px-0 my-4">
        <MudTable @ref="@_table" Items="@_clients.Items" Loading="@_loading" RowsPerPage="10" Hover Dense Class="pt-2">
            <ToolBarContent>
                <MudGrid Spacing="2" Justify="Justify.FlexStart" Class="pr-2 mb-2">
                    <MudItem xs="12" sm="12" md="12" lg="12">
                        <ExatoSearchTextField
                            Clearable
                            OnClick="@Refresh"
                            Disabled="@_loading"
                            @bind-Value="@_filters.Search"
                            @bind-Value:after="@HandleSearchClear"
                            Placeholder="CNPJ, nome ou razão social"
                        />
                    </MudItem>
                    <MudItem xs="12" sm="3" md="3" lg="3">
                        <MudSelect
                            Dense
                            Clearable
                            Label="Tipo"
                            T="TipoDeEmpresa?"
                            Placeholder="Todas"
                            Margin="Margin.Dense"
                            @bind-Value="@_filters.ClientType"
                            @bind-Value:after="@Refresh"
                            Variant="Variant.Outlined"
                        >
                            @foreach (TipoDeEmpresa? item in Enum.GetValues<TipoDeEmpresa>())
                            {
                                var (color, icon, tipo) = item.Value.GetProps();
                                <MudSelectItem Value="@item">
                                    <MudStack Row AlignItems="AlignItems.Center">
                                        <MudIcon Class="mb-1" Icon="@icon" Color="@color" Size="Size.Small" />
                                        <MudText>@tipo</MudText>
                                    </MudStack>
                                </MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="3" md="3" lg="3">
                        <MudSelect
                            Dense
                            T="bool?"
                            Clearable
                            Label="Status"
                            Placeholder="Todos"
                            Margin="Margin.Dense"
                            @bind-Value="@_filters.IsActive"
                            @bind-Value:after="@Refresh"
                            Variant="Variant.Outlined"
                        >
                            <MudSelectItem T="bool?" Value="true">
                                <MudStack Row AlignItems="AlignItems.Center">
                                    <MudIcon Class="mb-1" Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                    <MudText>Ativas</MudText>
                                </MudStack>
                            </MudSelectItem>
                            <MudSelectItem T="bool?" Value="false">
                                <MudStack Row AlignItems="AlignItems.Center">
                                    <MudIcon Class="mb-1" Icon="@Icons.Material.Filled.RemoveCircleOutline" Color="Color.Default" Size="Size.Small" />
                                    <MudText>Inativas</MudText>
                                </MudStack>
                            </MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="3" md="3" lg="3">
                        <MudSelect
                            Dense
                            T="MetodoDePagamento?"
                            Clearable
                            Label="Pagamento"
                            Placeholder="Todos"
                            Margin="Margin.Dense"
                            @bind-Value="@_filters.PaymentMethod"
                            @bind-Value:after="@Refresh"
                            Variant="Variant.Outlined"
                        >
                            <MudSelectItem T="MetodoDePagamento?" Value="MetodoDePagamento.PrePago">
                                <MudStack Row AlignItems="AlignItems.Center">
                                    <MudIcon Class="mb-1" Icon="@Icons.Material.Filled.Circle" Color="Color.Tertiary" Size="Size.Small" />
                                    <MudText>@MetodoDePagamento.PrePago.GetDescription()</MudText>
                                </MudStack>
                            </MudSelectItem>
                            <MudSelectItem T="MetodoDePagamento?" Value="MetodoDePagamento.PosPago">
                                <MudStack Row AlignItems="AlignItems.Center">
                                    <MudIcon Class="mb-1" Icon="@Icons.Material.Filled.Circle" Color="Color.Info" Size="Size.Small" />
                                    <MudText>@MetodoDePagamento.PosPago.GetDescription()</MudText>
                                </MudStack>
                            </MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="3" md="3" lg="3">
                        <MudSelect
                            Dense
                            Clearable
                            Label="Onboard"
                            T="ExatoWebOnboardStatus?"
                            Placeholder="Todos"
                            Margin="Margin.Dense"
                            @bind-Value="@_filters.OnboardStatus"
                            @bind-Value:after="@Refresh"
                            Variant="Variant.Outlined"
                        >
                            @foreach (ExatoWebOnboardStatus? item in Enum.GetValues<ExatoWebOnboardStatus>())
                            {
                                <MudSelectItem Value="@item">@item.GetDescription()</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>CNPJ</MudTh>
                <MudTh>Nome</MudTh>
                <MudTh>Razão social</MudTh>
                <MudTh>Início</MudTh>
                <MudTh>Pagamento</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="CNPJ">
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                        @{ var (color, icon, status) = @context.GetIsActive(); }
                        <MudTooltip Text="@status" Arrow Placement="Placement.Top">
                            <MudIcon Size="@Size.Small" Icon="@icon" Color="@color" />
                        </MudTooltip>
                        @{ var (typeColor, typeIcon, _) = @context.Tipo.GetProps(); }
                        <MudTooltip Text="@context.Tipo.GetDescription()" Arrow Placement="Placement.Top">
                            <MudIcon Size="@Size.Small" Icon="@typeIcon" Color="@typeColor" />
                        </MudTooltip>
                        <MudText Typo="Typo.body2">@context.CNPJ.AsFormatedDocument()</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Nome">@context.Nome</MudTd>
                <MudTd DataLabel="Razão social">@context.RazaoSocial</MudTd>
                <MudTd DataLabel="Início">
                    <MudTooltip Text="@context.CriadaEm.ToTimeString()" Arrow Placement="Placement.Top">
                        @context.CriadaEm.ToDateString()
                    </MudTooltip>
                </MudTd>
                <MudTd DataLabel="Pagamento">
                    @{ var (color, method) = @context.GetPaymentMethod(); }
                    <MudChip T="string" Label="true" Color="@color">@method</MudChip>    
                </MudTd>
                <MudTd>
                    <AuthorizeView Policy="@Policies.ViewOfficeEmpresaPage" Context="authCtx">
                        <MudTooltip Text="Detalhes" Arrow Placement="Placement.Top" ShowOnFocus="false">
                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.RemoveRedEye" Href="@($"/office/empresas/{context.Id}")" />
                        </MudTooltip>
                    </AuthorizeView>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudDivider DividerType="DividerType.FullWidth"/>
                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mx-4">
                    <MudTooltip Text="Total de registros" Arrow Placement="Placement.Top">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Size="@Size.Medium" Icon="@Icons.Material.Filled.ViewHeadline" />
                            <MudText><strong>@_clients.Total.ToIntFormat()</strong></MudText>
                        </MudStack>
                    </MudTooltip>
                    <MudPagination
                        Rectangular
                        Class="pa-4"
                        MiddleCount="3"
                        BoundaryCount="1"
                        Variant="Variant.Text"
                        Color="Color.Secondary"
                        @bind-Selected="@_page"
                        @bind-Selected:after="@HandlePageChange"
                        Count="@((_clients.Total + 9) / 10)"
                    />
                </MudStack>
            </PagerContent>
            <NoRecordsContent>
                Nenhuma empresa encontrada.
            </NoRecordsContent>
        </MudTable>
    </MudContainer>
</MudContainer>

<AuthorizeView Policy="@Policies.OfficeCriarEmpresa">
    <CriarEmpresaDrawer @ref="@_criarEmpresaDrawer" AfterSubmit="@Refresh" />
</AuthorizeView>

@inject NavigationManager Nav
@inject BuscarEmpresasClient Client

@code
{
    private int _page = 1;
    private bool _loading;

    private BuscarEmpresasFilterData _filters = new();
    private MudTable<BuscarEmpresasItemOut> _table;
    private BuscarEmpresasOut _clients = new();

    private CriarEmpresaDrawer _criarEmpresaDrawer;

    protected override async Task OnParametersSetAsync()
    {
        Nav.ApplyQueryToFilterState(_filters);
        await Refresh();
    }

    private async Task Refresh()
    {
        Nav.UpdateQueryString(_filters);

        _loading = true;

        var query = new BuscarEmpresasIn { Page = 0, IsActive = _filters.IsActive, Search = _filters.Search, PaymentMethod = _filters.PaymentMethod, ClientType = _filters.ClientType, OnboardStatus = _filters.OnboardStatus, };
        _clients = await Client.Get(query);

        if (_page != 1)
        {
            _page = 1;
            _table.NavigateTo(0);
        }

        _loading = false;
    }

    private async Task HandleSearchClear()
    {
        if (_filters.Search.HasValue()) return;

        await Refresh();
    }

    private async Task HandlePageChange()
    {
        _loading = true;

        var cnpj = _filters.Search.CanBeDocument() ? _filters.Search.OnlyNumbers() : null;
        var name = !_filters.Search.CanBeDocument() ? _filters.Search : null;
        var query = new BuscarEmpresasIn { Page = _page - 1, IsActive = _filters.IsActive, Search = _filters.Search, PaymentMethod = _filters.PaymentMethod, ClientType = _filters.ClientType, OnboardStatus = _filters.OnboardStatus, };
        _clients = await Client.Get(query);

        _table.NavigateTo(_page - 1);

        _loading = false;
    }

    private async Task OpenDrawer()
    {
        await _criarEmpresaDrawer.Open();
    }
}
