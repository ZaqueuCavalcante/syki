@using System.Linq.Expressions
@using Exato.Front.Components.Empresas
@using Exato.Front.Features.Office.BuscarPotenciaisEmpresasDoUsuario
@using Exato.Shared.Features.Office.BuscarPotenciaisEmpresasDoUsuario

@namespace Exato.Front.Components.Usuarios

<MudAutocomplete
	Dense
	For="@For"
	MaxItems=50
	Class="pb-2"
	Value="@Value"
	Strict="false"
	Label="Empresa"
	SearchFunc="@Search"
	Margin="Margin.Dense"
	ResetValueOnEmptyText
	ShowProgressIndicator
	DebounceInterval="500"
	Variant="Variant.Outlined"
	ValueChanged="@ValueChanged"
	T="PotencialEmpresaDoUsuarioSelectData"
	AdornmentIcon="@Icons.Material.Filled.Search"
	ToStringFunc="@(e => e == null ? null : $"{e.Nome}")"
>
	<ItemTemplate Context="e">
		<MudStack Spacing="0">
			<MudText>@e.Nome</MudText>
			<MudStack Row AlignItems="AlignItems.Center" Spacing="2">
				@{ var (color, icon) = e.GetIsActive(); }
				<MudIcon Size="@Size.Small" Icon="@icon" Color="color" />
				@{ var (typeColor, typeIcon, _) = e.Tipo.GetProps(); }
				<MudIcon Size="@Size.Small" Icon="@typeIcon" Color="@typeColor" />
				<MudText Typo="Typo.body2">@e.CNPJ.AsFormatedDocument()</MudText>
			</MudStack>
		</MudStack>
	</ItemTemplate>
	<NoItemsTemplate>
		<MudStack Row Spacing="0" AlignItems="AlignItems.Center" Justify="Justify.Center">
			<MudText Typo="Typo.body1">Nenhuma empresa encontrada</MudText>
		</MudStack>
	</NoItemsTemplate>
</MudAutocomplete>

@inject BuscarPotenciaisEmpresasDoUsuarioClient Client

@code
{
	[Parameter]
	public int Id { get; set; }

	[Parameter]
	public PotencialEmpresaDoUsuarioSelectData Value { get; set; }

    [Parameter]
    public EventCallback<PotencialEmpresaDoUsuarioSelectData> ValueChanged { get; set; }

    [Parameter]
    public Expression<Func<PotencialEmpresaDoUsuarioSelectData>>? For { get; set; }

    protected override async Task OnParametersSetAsync()
    {
		await Task.Yield();
    }

    private async Task<IEnumerable<PotencialEmpresaDoUsuarioSelectData>> Search(string value, CancellationToken token)
    {
		var query = new BuscarPotenciaisEmpresasDoUsuarioIn { CnpjOuNome = value };
		var response = await Client.Get(Id, query);

		return response.Items.ConvertAll(x => new PotencialEmpresaDoUsuarioSelectData { Id = x.Id, Ativa = x.Ativa, Nome = x.Nome, CNPJ = x.CNPJ, Tipo = x.Tipo });
    }
}
