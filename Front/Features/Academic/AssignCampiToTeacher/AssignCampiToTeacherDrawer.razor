@namespace Syki.Front.Features.Academic.AssignCampiToTeacher

<MudDrawer @bind-Open="@_open" Width="@_width" Anchor="Anchor.Right" Elevation="1" Variant="@DrawerVariant.Temporary">
	<MudDrawerHeader Class="justify-space-between">
		<MudStack Row Justify="Justify.FlexStart" AlignItems="AlignItems.Center" Spacing="3">
			<MudIcon Icon="@Icons.Material.Filled.GroupWork" />
			<MudText Typo="Typo.h5"><b>Campi do professor</b></MudText>
		</MudStack>
		<MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@Close" />
    </MudDrawerHeader>

    <MudGrid Spacing="1" Class="px-6">
        <MudForm @ref="@_form" Style="width: 100%">
            <MudGrid Spacing="2">
                <MudItem xs="12" Class="my-2">
                    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.FlexStart" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Person4" Size="Size.Medium" />
                        <MudText Typo="Typo.h6"><b>@_teacher.Name</b></MudText>
                    </MudStack>
                </MudItem>

                <MudItem xs="12">
                    <SykiTitleText Icon="@GetSelectedCampiIcon()" Text="@GetSelectedCampiTitle()" />
                </MudItem>

                <MudItem xs="12">
                    <MudAutocomplete
                        MaxItems="50"
                        T="AssignCampiToTeacherSelect"
                        SearchFunc="@SearchCampus"
                        Dense
                        Placeholder=""
                        ToStringFunc="@(e => null)"
                        DebounceInterval="100"
                        ResetValueOnEmptyText
                        Margin="Margin.Dense"
                        Variant="Variant.Outlined"
                        Class="mb-2"
                        Value="@_campus"
                        ValueChanged="(AssignCampiToTeacherSelect newValue) => HandleCampusChanged(newValue)"
                        Label="Campus"
                        AdornmentColor="Color.Primary"
                    >
                        <ItemTemplate Context="e">
                            <MudStack Row Spacing="0">
                                <MudText Typo="Typo.body1">@e.Name</MudText>
                            </MudStack>
                        </ItemTemplate>
                        <NoItemsTemplate>
                            <MudStack Row Spacing="0" AlignItems="AlignItems.Center" Justify="Justify.Center">
                                <MudText Typo="Typo.body1">Nenhum campus encontrado</MudText>
                            </MudStack>
                        </NoItemsTemplate>
                    </MudAutocomplete>
                </MudItem>
            </MudGrid>

            <MudItem xs="12" Class="mt-2">
                @if (_selectedCampi.Count > 0)
                {
                    <MudDataGrid
                        Dense
                        Hover
                        Class="my-2"
                        SortMode="SortMode.None"
                        Items="@_selectedCampi.OrderBy(d => d.Name)"
                    >
                        <Columns>
                            <PropertyColumn Property="x => x.Name" Title="Campus" />
                            <TemplateColumn CellClass="d-flex justify-end">
                                <CellTemplate>
                                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="@Color.Error" OnClick="@(() => UnselectCampus(context.Item))" />
                                </CellTemplate>
                            </TemplateColumn>
                        </Columns>
                    </MudDataGrid>
                }
            </MudItem>
        </MudForm>
    </MudGrid>

    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Spacing="3" Class="px-2 pt-6">
        <DialogCancelButton OnClick="@Close" />
        <DialogSaveButton OnClick="@Submit" Disabled="@_selectedCampi.Select(x => x.Id).ToList().IsEquivalentTo(_teacher.Campi.ConvertAll(x => x.Id))" />
    </MudStack>
</MudDrawer>

@inject ISnackbar Snackbar
@inject NavigationManager Nav
@inject GetCampiClient GetCampiClient
@inject IBrowserViewportService BrowserViewportService
@inject GetAcademicTeacherClient GetAcademicTeacherClient
@inject AssignCampiToTeacherClient AssignCampiToTeacherClient

@code
{
    [Parameter]
    public EventCallback AfterSubmit { get; set; }

    private bool _open;
    private string _width = "520px";
    private Breakpoint _breakpoint;
    
    private MudForm _form;
    private bool _loading;

    private GetAcademicTeacherOut _teacher = new();

    private AssignCampiToTeacherSelect? _campus;
    private List<AssignCampiToTeacherSelect> _campi = [];
    private HashSet<AssignCampiToTeacherSelect> _selectedCampi = [];

    protected override async Task OnInitializedAsync()
    {
        _breakpoint = await BrowserViewportService.GetCurrentBreakpointAsync();
        _width = _breakpoint == Breakpoint.Xs ? "100%" : "520px";
        _campi = (await GetCampiClient.Get()).Items.ConvertAll(x => new AssignCampiToTeacherSelect() { Id = x.Id, Name = x.Name });
    }

    private async Task<IEnumerable<AssignCampiToTeacherSelect>> SearchCampus(string value, CancellationToken cancellationToken)
    {
        await Task.Yield();

        var filtered = _campi.Where(d => !d.IsSelected)
            .ToList().ConvertAll(x => new AssignCampiToTeacherSelect { Id = x.Id, Name = x.Name });

        if (string.IsNullOrEmpty(value))
            return filtered;

        return filtered.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private void HandleCampusChanged(AssignCampiToTeacherSelect newValue)
    {
        _campi.First(d => d.Id == newValue.Id).IsSelected = true;
        _selectedCampi.Add(newValue);
    }

    private void UnselectCampus(AssignCampiToTeacherSelect campus)
    {
        _campi.FirstOrDefault(d => d.Id == campus.Id)?.IsSelected = false;
        _selectedCampi.Remove(campus);
    }

    public async Task Open(Guid teacherId)
    {
        _loading = true;

        var response = await GetAcademicTeacherClient.Get(teacherId);
        if (response.IsSuccess)
        {
            _teacher = response.Success;
            _selectedCampi = _teacher.Campi
                .Select(x => new AssignCampiToTeacherSelect() { Id = x.Id, Name = x.Name })
                .ToHashSet();
        }
        else
        {
            Snackbar.Add(response.Error.Message, Severity.Error);
        }

        _campus = null;
        _campi.ForEach(x => x.IsSelected = _selectedCampi.Any(c => c.Id == x.Id));

        _open = true;
        await _form?.ResetAsync();

        _loading = false;

        StateHasChanged();
    }

    private void Close()
    {
        _open = false;
    }

    private async Task Submit()
    {
        if (_loading) return;

        await _form.Validate();
        if (!_form.IsValid) return;
      
        _loading = true;
        var selectedCampi = _selectedCampi.Select(x => x.Id).ToList();
        var response = await AssignCampiToTeacherClient.Assign(_teacher.Id, selectedCampi);
        if (response.IsSuccess)
        {
            Snackbar.Add("Campus salvos com sucesso!", Severity.Success);
            await AfterSubmit.InvokeAsync();
            _open = false;
        }
        else
        {
            Snackbar.Add(response.Error.Message, Severity.Error);
        }
        _loading = false;
    }

    private string GetSelectedCampiIcon()
    {
        var count = _selectedCampi.Count;
        if (count == 0) return Icons.Material.Filled.Error;

        return Icons.Material.Filled.Check;
    }

    private string GetSelectedCampiTitle()
    {
        var count = _selectedCampi.Count;
        if (count == 0) return "Nenhum campus selecionado";

        if (count == 1) return $"1 campus selecionado";

        return $"{count} campus selecionados";
    }
}
