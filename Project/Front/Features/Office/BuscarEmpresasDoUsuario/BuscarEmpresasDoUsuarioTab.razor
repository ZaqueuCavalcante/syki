@using Exato.Front.Components.Empresas
@using Exato.Front.Features.Office.VincularEmpresaUsuario
@using Exato.Shared.Features.Office.BuscarEmpresasDoUsuario
@using Exato.Front.Features.Office.VincularEmpresasAoUsuario
@using Exato.Front.Features.Office.DesvincularEmpresaUsuario

@namespace Exato.Front.Features.Office.BuscarEmpresasDoUsuario

<AuthorizeView Policy="@Policies.OfficeVincularUsuarioEmpresa">
    <MudGrid Spacing="3">
        <MudItem xs="12" sm="12" md="12" lg="12" Class="d-flex justify-end" Style="max-height: 50px">
            <TabEditButton Text="Empresa" Icon="@Icons.Material.Outlined.Add" OnClick="@OpenDrawer" />
        </MudItem>
    </MudGrid>
</AuthorizeView>

<MudTable @ref="@_table" Items="@_empresas.Items" Loading="@_loading" RowsPerPage="10" Hover Dense Elevation="0" Class="mt-4">
    <HeaderContent>
        <MudTh>Documento</MudTh>
        <MudTh>Nome</MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Documento">
            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                @{ var (color, icon, status) = @context.GetIsActive(); }
                <MudTooltip Text="@status" Arrow Placement="Placement.Top">
                    <MudIcon Size="@Size.Small" Icon="@icon" Color="color" />
                </MudTooltip>
                @{ var (typeColor, typeIcon, _) = @context.Tipo.GetProps(); }
                <MudTooltip Text="@context.Tipo.GetDescription()" Arrow Placement="Placement.Top">
                    <MudIcon Size="@Size.Small" Icon="@typeIcon" Color="@typeColor" />
                </MudTooltip>
                <MudText Typo="Typo.body2">@context.CNPJ.AsFormatedDocument()</MudText>
            </MudStack>
        </MudTd>
        <MudTd DataLabel="Nome">@context.Nome</MudTd>
        <MudTd>
            <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.FlexEnd" Spacing="1">
                <AuthorizeView Policy="@Policies.ViewOfficeEmpresaPage" Context="authCtx">
                    <MudTooltip Text="Detalhes" Arrow Placement="Placement.Top" ShowOnFocus="false">
                        <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.RemoveRedEye" Href="@($"/office/empresas/{context.Id}")" />
                    </MudTooltip>
                </AuthorizeView>
                <AuthorizeView Policy="@Policies.OfficeDesvincularUsuarioEmpresa" Context="authCtx">
                    <MudTooltip Text="Desvincular" Arrow Placement="Placement.Top" ShowOnFocus="false">
                        <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.DeleteOutline" OnClick="@(() => OpenDesvincularEmpresaUsuarioDialog(context.Id))" />
                    </MudTooltip>
                </AuthorizeView>
            </MudStack>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudDivider DividerType="DividerType.FullWidth"/>
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mx-4">
            <MudTooltip Text="Total de registros" Arrow Placement="Placement.Top">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Size="@Size.Medium" Icon="@Icons.Material.Filled.ViewHeadline" />
                    <MudText><strong>@_empresas.Total.ToIntFormat()</strong></MudText>
                </MudStack>
            </MudTooltip>
            <MudPagination
                Rectangular
                Class="pa-4"
                MiddleCount="3"
                BoundaryCount="1"
                Color="Color.Secondary"
                @bind-Selected="@_page"
                @bind-Selected:after="@HandlePageChange"
                Variant="Variant.Text"
                Count="@((_empresas.Total + 9) / 10)"
            />
        </MudStack>
    </PagerContent>
    <NoRecordsContent>
        Nenhuma empresa encontrada.
    </NoRecordsContent>
</MudTable>

<AuthorizeView Policy="@Policies.OfficeVincularUsuarioEmpresa">
    <VincularEmpresasAoUsuarioDrawer @ref="@_drawer" Id="@Id" AfterSubmit="@Refresh" />
</AuthorizeView>

@inject IDialogService DialogService
@inject BuscarEmpresasDoUsuarioClient Client
@inject IBrowserViewportService BrowserViewportService

@code
{
    [Parameter]
    public int Id { get; set; }

    [Parameter]
    public EventCallback ReloadUserData { get; set; }

    private int _page = 1;
    private bool _loading;
    private VincularEmpresasAoUsuarioDrawer _drawer;

    private MudTable<BuscarEmpresasDoUsuarioItemOut> _table;
    private BuscarEmpresasDoUsuarioOut _empresas = new();

    protected override async Task OnParametersSetAsync()
    {
        await Refresh();
    }

    private async Task OpenDrawer()
    {
        await _drawer.Open();
    }

    private async Task Refresh()
    {
        _loading = true;

        var query = new BuscarEmpresasDoUsuarioIn { Page = 0 };
        _empresas = await Client.Get(Id, query);

        if (_page != 1)
        {
            _page = 1;
            _table.NavigateTo(0);
        }

        _loading = false;
    }

    private async Task HandlePageChange()
    {
        _loading = true;

        var query = new BuscarEmpresasDoUsuarioIn { Page = _page - 1 };
        _empresas = await Client.Get(Id, query);

        _table.NavigateTo(_page - 1);

        _loading = false;
    }

    private async Task OpenDesvincularEmpresaUsuarioDialog(int clienteId)
    {
        var breakpoint = await BrowserViewportService.GetCurrentBreakpointAsync();
        var options = new DialogOptions {
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = true,
            FullScreen = breakpoint == Breakpoint.Xs,
        };
        var parameters = new DialogParameters<DesvincularEmpresaUsuarioDialog>
        {
            { x => x.ClienteId, clienteId },
            { x => x.UserId, Id },
        };
        var dialog = await DialogService.ShowAsync<DesvincularEmpresaUsuarioDialog>("", parameters, options);

        var result = await dialog.Result;

        if (result!.Canceled) return;
        
        await Refresh();
        await ReloadUserData.InvokeAsync();
    }
}
